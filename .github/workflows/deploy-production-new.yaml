name: Deploy to New Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: pip install -r adoorback/requirements.txt

      - name: Connect to EC2 and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NEW_SERVER_HOST }}
          username: ${{ secrets.NEW_SERVER_USER }}
          key: ${{ secrets.NEW_SERVER_KEY }}
          script: |
            echo "ğŸš€ ìµœì‹  ì½”ë“œ Pull ë°›ê¸°"
            cd ~/WhoamI-Today-backend
            git pull

            echo "ğŸ”„ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ í™•ì¸"
            CURRENT_BACKEND=$(docker ps --format '{{.Names}}' | grep whoami-backend | head -n 1)

            if [ "$CURRENT_BACKEND" == "whoami-backend-blue" ]; then
              TARGET_BACKEND="whoami-backend-green"
            else
              TARGET_BACKEND="whoami-backend-blue"
            fi

            echo "ğŸ›‘ $TARGET_BACKEND ë°°í¬ ì‹œì‘"
            docker compose -f docker-compose.production.yml up --build -d $TARGET_BACKEND

            echo "ğŸ”„ Nginx ì¬ì‹œì‘"
            docker exec nginx-reverse-proxy nginx -s reload

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
